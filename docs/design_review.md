Design Review — SoulBrowser Core Design Assessment

目标与范围
- 评估点覆盖核心架构：CLI <-> Kernel <-> 感知/执行/网关，以及配置、策略、权限、观察等治理层。指出潜在设计风险，给出可落地的改进路线。 
- 关注点：边界清晰性、租户隔离、默认安全、错误诊断、一致性、测试性、文档同步。

一、现状摘要
- 优点
  - 模块化设计，层次分明，便于定位与扩展。
  - 支持多模态感知、LLM/Planner、策略中心、插件体系，具备演化潜力。
- 核心风险点（设计层级）
  - AppContext 的职责过于集中，边界不清，耦合度高。
  - 租户隔离与缓存边界模糊，缓存键依赖策略哈希，策略变更未必能及时触发失效。
  - 安全默认态势不明确：Serve 未认证时默认禁用暴露、但文档与实现之间易产生误解。
  - 错误处理不统一：混用 SoulBrowserError 与 anyhow，导致对外错误输出不一致。
  - Surfaces 与 Kernel 的生命周期耦合，难以在高并发场景下确保清理与隔离。
  - 外部依赖测试困难：对 Chrome/CDP 的依赖较强，Mock/测试路径需要增强。
  - 文档与实现同步成本高，缺少一致的设计变更记录与契约。

二、具体问题与改进方向（分点列出）
1) AppContext -> 职责边界与缓存
- 问题：集中管理存储/认证/工具/策略/注册表/调度等，边界模糊。
- 改进点：将组件职责拆分为独立服务或模块，形成明确 API 边界；缓存引入策略版本号和显式失效入口，租户隔离性提升。
- 风险缓解：降低跨租户状态污染与策略变更引发的不可预期行为。

2) 安全默认态势
- 问题：Serve auth disabled 时提示强警告，默认对外暴露存在风险；缺少强制性基线。
- 改进点：将默认设为需要鉴权，提供显式开关来覆盖；config.yaml/环境变量有统一说明与校验。
- 风险缓解：减少生产环境暴露与误用。

3) 配置与行为可预测性
- 问题：覆盖顺序不清晰，配置来源混乱。
- 改进点：统一配置解析入口，明确优先级（ENV > YAML > defaults），提供 config lint/validate 命令。
- 风险缓解：避免意外行为，提升新成员入门效率。

4) 错误处理与诊断一致性
- 问题：错误类型分散，外部调用错误信息不一致。
- 改进点：引入统一的外部错误类型（SoulBrowserError），内部使用 anyhow，对外统一映射输出。
- 风险缓解：提升日志可读性与排错效率。

5) Surfaces 与 Kernel 的生命周期与隔离
- 问题：多表面共用同一 Kernel，资源竞争与清理复杂性风险。
- 改进点：引入 Surface 级别的生命周期边界，必要时面向租户创建独立运行环境或清晰的资源池隔离。
- 风险缓解：降低并发下的状态污染风险，提升系统稳定性。

6) 测试覆盖与对外依赖
- 问题：大量依赖 Chrome/CDP，测试覆盖度不足。
- 改进点：引入可控 Mock 路径、提供接口分离以替换底层驱动；增加端到端集成测试用例。
- 风险缓解：CI/本地回归更稳定，迭代更快。

7) 文档同步与契约
- 问题：架构变更频繁，文档难以实现即时同步。
- 改进点：引入设计变更日志、契约文档与自动化生成的模块地图，确保实现和文档一致。

三、改进优先级与快速落地路径
- 最高优先（高影响、低成本/高收益）
  - 安全默认态势：将 Serve 的鉴权设为强基线，提供明确开关，更新文档与示例。
  - 统一错误边界：引入 SoulBrowserError 作为外部接口错误类型，统一输出格式。
- 中等优先（中等影响、可迭代）
  - 配置与解析统一入口：引入配置解析模块，确定优先级 & 校验，增加 lint/validate。
  - AppContext 边界拆分初步：把存储/认证/工具管理等初步拆分为独立组件的雏形，先实现最小耦合点。
- 长期（需要结构性改动）
  - Surfaces 生命周期隔离策略：为不同 surface 提供清晰的资源域/上下文，降低耦合。
  - Mock/测试覆盖全面提升：对 CDP/浏览器驱动建立完善的 Mock 层，提升 CI 质量。
  - 设计变更治理：建立变更日志与设计契约，确保文档与实现同步。

四、落地执行建议（第一步推荐）
- 选项 A：强化安全默认态势与文档同步（最直接降低风险、影响面明确）。具体执行：
  - 将 Serve token 要求改为“至少一个 token/白名单”，并在 config/docs 中清晰说明默认行为及开关；
  更新运行示例，确保默认不会对外暴露端口。
- 选项 B：实现统一错误边界（更改对外 API 错误传播入口，提供清晰错误码/上下文）。
- 选项 C：引入配置 lint/validate 与统一入口（提升可预测性）。

五、后续沟通与执行方式
- 你更希望我先从哪一个方向着手？我可以给出具体的实现方案与补丁草案，例如：
  - 第一版补丁（安全默认态势）对应的修改清单、涉及文件、潜在测试用例；
  - 或者第一版的错误类型统一实现草案及相关单元测试设计。
- 如果你愿意，我也可以把此设计评审扩展成一个小型的设计变更计划（todowrite）并生成一个可执行的 commit plan。 

六、参考与链接
- 设计评审文档计划：docs/design_review.md（新文档，这里已创建）
- 机构化复用的架构理解可参考 docs/module_deep_dive.md（作为对照）

要不要我把上述要点整理成一个 todowrite 的计划条目，并附上具体要实现的第一轮补丁清单？如果你愿意，请告诉我你优先的改动方向（A/B/C），我就给出第一步的具体实现草案与代码修改点。