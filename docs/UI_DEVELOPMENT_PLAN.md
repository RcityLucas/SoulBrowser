# SoulBrowser å¯è§†åŒ–æ“ä½œç•Œé¢è¯¦ç»†å¼€å‘è®¡åˆ’

**æ–‡æ¡£æ—¥æœŸ**: 2025-10-21
**ç›®çš„**: è¯¦ç»†è§„åˆ’ SoulBrowser Web æ§åˆ¶å°çš„å¼€å‘ï¼Œæä¾›ç»™ç”¨æˆ·ç›´è§‚çš„å¯è§†åŒ–æ“ä½œä½“éªŒ

---

## ä¸€ã€æ•´ä½“æ¶æ„è®¾è®¡

### 1.1 æŠ€æœ¯æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·æµè§ˆå™¨                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              React/Vue å‰ç«¯åº”ç”¨                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚å¯¹è¯ç•Œé¢â”‚  â”‚ä»»åŠ¡é¢æ¿â”‚  â”‚å®æ—¶é¢„è§ˆâ”‚  â”‚ç›‘æ§ä»ªè¡¨ç›˜â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                        â”‚                         â”‚
â”‚            â”‚ HTTP/REST API         â”‚ WebSocket               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                        â”‚
             â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Rust åç«¯æœåŠ¡å™¨ (Axum)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  API Gateway Layer                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚REST Endpointâ”‚  â”‚WebSocket Hubâ”‚  â”‚Auth Middlewareâ”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 Application Layer                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚Agent Coreâ”‚  â”‚Task Managerâ”‚ â”‚Visualization Serviceâ”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Core SoulBrowser Layers                  â”‚   â”‚
â”‚  â”‚  L0-L7: CDP, Perceiver, Actions, Tools, Adapters     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Chrome/Chromium Browser                       â”‚
â”‚                    (CDP Protocol)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯æ ˆé€‰å‹

#### å‰ç«¯æŠ€æœ¯æ ˆï¼ˆæ¨èæ–¹æ¡ˆï¼‰

**æ–¹æ¡ˆ A: React + TypeScriptï¼ˆæ¨èï¼‰**
- **æ¡†æ¶**: React 18+ with TypeScript
- **UI ç»„ä»¶åº“**: Ant Design / shadcn/ui
- **çŠ¶æ€ç®¡ç†**: Zustand / Jotaiï¼ˆè½»é‡çº§ï¼‰
- **å®æ—¶é€šä¿¡**: Socket.IO Client / native WebSocket
- **å›¾è¡¨å¯è§†åŒ–**: ECharts / Recharts
- **ä»£ç ç¼–è¾‘å™¨**: Monaco Editorï¼ˆVS Code åŒæ¬¾ï¼‰
- **æ„å»ºå·¥å…·**: Vite
- **æ ·å¼æ–¹æ¡ˆ**: Tailwind CSS

**æ–¹æ¡ˆ B: Vue 3 + TypeScriptï¼ˆå¤‡é€‰ï¼‰**
- **æ¡†æ¶**: Vue 3 Composition API + TypeScript
- **UI ç»„ä»¶åº“**: Element Plus / Naive UI
- **çŠ¶æ€ç®¡ç†**: Pinia
- **å®æ—¶é€šä¿¡**: Socket.IO Client
- **å›¾è¡¨å¯è§†åŒ–**: ECharts
- **ä»£ç ç¼–è¾‘å™¨**: Monaco Editor
- **æ„å»ºå·¥å…·**: Vite
- **æ ·å¼æ–¹æ¡ˆ**: UnoCSS

#### åç«¯æŠ€æœ¯æ ˆï¼ˆåŸºäºç°æœ‰ï¼‰
- **Web æ¡†æ¶**: Axumï¼ˆå·²ä½¿ç”¨ï¼‰
- **WebSocket**: axum::extract::ws
- **åºåˆ—åŒ–**: serde + serde_jsonï¼ˆå·²ä½¿ç”¨ï¼‰
- **æŒ‡æ ‡ç›‘æ§**: Prometheusï¼ˆå·²ä½¿ç”¨ï¼‰
- **è®¤è¯**: JWT + OAuth2ï¼ˆå¾…æ·»åŠ ï¼‰
- **æ•°æ®å­˜å‚¨**: SQLite/PostgreSQLï¼ˆçŠ¶æ€æŒä¹…åŒ–ï¼‰

---

## äºŒã€è¯¦ç»†åŠŸèƒ½æ¨¡å—è®¾è®¡

### 2.1 å¯¹è¯äº¤äº’æ¨¡å—

#### 2.1.1 åŠŸèƒ½éœ€æ±‚
- è‡ªç„¶è¯­è¨€ä»»åŠ¡è¾“å…¥
- å†å²ä¼šè¯è®°å½•
- ä¸Šä¸‹æ–‡æ„ŸçŸ¥æç¤º
- å¤šè½®å¯¹è¯æ”¯æŒ
- ä»»åŠ¡æ¨¡æ¿å¿«é€Ÿé€‰æ‹©

#### 2.1.2 ç•Œé¢è®¾è®¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SoulBrowser Console                        [ç”¨æˆ·å¤´åƒ]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚ ä»»åŠ¡æ¨¡æ¿    â”‚  ğŸ“‹ è¡¨å•è‡ªåŠ¨å¡«å†™                       â”‚
â”‚  â”‚             â”‚  ğŸ” ç½‘é¡µæ•°æ®é‡‡é›†                       â”‚
â”‚  â”‚             â”‚  ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯•                         â”‚
â”‚  â”‚             â”‚  ğŸ“Š ç«å“ç›‘æ§                           â”‚
â”‚  â”‚             â”‚  â• è‡ªå®šä¹‰ä»»åŠ¡                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ¤–: ä½ å¥½ï¼æˆ‘å¯ä»¥å¸®ä½ å®Œæˆç½‘é¡µè‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚          â”‚  â”‚
â”‚  â”‚      è¯·æè¿°ä½ æƒ³è¦åšä»€ä¹ˆï¼Ÿ                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ‘¤: å¸®æˆ‘ç™»å½• example.com å¹¶å¡«å†™è”ç³»è¡¨å•          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ğŸ¤–: å¥½çš„ï¼Œæˆ‘å·²ç»ç†è§£ä½ çš„ä»»åŠ¡ã€‚æˆ‘ä¼šï¼š              â”‚  â”‚
â”‚  â”‚      1. å¯¼èˆªåˆ° example.com                         â”‚  â”‚
â”‚  â”‚      2. å®šä½ç™»å½•è¡¨å•å¹¶å¡«å†™å‡­æ®                     â”‚  â”‚
â”‚  â”‚      3. æ‰¾åˆ°è”ç³»è¡¨å•å¹¶å¡«å†™ä¿¡æ¯                     â”‚  â”‚
â”‚  â”‚      4. æäº¤è¡¨å•å¹¶éªŒè¯ç»“æœ                         â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚      [æŸ¥çœ‹è¯¦ç»†è®¡åˆ’] [å¼€å§‹æ‰§è¡Œ] [ä¿®æ”¹ä»»åŠ¡]          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  è¯·è¾“å…¥ä»»åŠ¡æè¿°...                    [å‘é€] ğŸ¤   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.1.3 æŠ€æœ¯å®ç°
```typescript
// å‰ç«¯ï¼šå¯¹è¯ç®¡ç†å™¨
interface Message {
  id: string;
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: Date;
  attachments?: TaskPlan[];
}

class ChatManager {
  private messages: Message[] = [];
  private ws: WebSocket;

  sendMessage(content: string): void {
    const message: Message = {
      id: uuid(),
      role: 'user',
      content,
      timestamp: new Date()
    };

    this.messages.push(message);
    this.ws.send(JSON.stringify({
      type: 'chat_message',
      payload: message
    }));
  }

  onTaskPlanReceived(plan: TaskPlan): void {
    // å±•ç¤ºä»»åŠ¡è®¡åˆ’å¡ç‰‡
  }
}
```

```rust
// åç«¯ï¼šWebSocket æ¶ˆæ¯å¤„ç†
use axum::extract::ws::{WebSocket, Message};

pub struct ChatHandler {
    agent_core: Arc<AgentCore>,
    state_center: Arc<StateCenter>,
}

impl ChatHandler {
    pub async fn handle_message(&self, msg: Message) -> Result<Response> {
        let chat_msg: ChatMessage = serde_json::from_str(&msg.to_text()?)?;

        // 1. è§£æç”¨æˆ·æ„å›¾
        let intent = self.agent_core.parse_intent(&chat_msg.content).await?;

        // 2. ç”Ÿæˆä»»åŠ¡è®¡åˆ’
        let plan = self.agent_core.create_plan(intent).await?;

        // 3. è¿”å›è®¡åˆ’ä¾›ç”¨æˆ·ç¡®è®¤
        Ok(Response::TaskPlan(plan))
    }
}
```

### 2.2 ä»»åŠ¡ç®¡ç†é¢æ¿

#### 2.2.1 åŠŸèƒ½éœ€æ±‚
- ä»»åŠ¡åˆ—è¡¨å±•ç¤ºï¼ˆè¿è¡Œä¸­ã€å·²å®Œæˆã€å¤±è´¥ï¼‰
- ä»»åŠ¡è¿›åº¦å®æ—¶æ›´æ–°
- ä»»åŠ¡è¯¦æƒ…æŸ¥çœ‹
- ä»»åŠ¡æ“ä½œï¼ˆæš‚åœã€æ¢å¤ã€å–æ¶ˆã€é‡è¯•ï¼‰
- ä»»åŠ¡å†å²è®°å½•

#### 2.2.2 ç•Œé¢è®¾è®¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»»åŠ¡ç®¡ç†                       [æ–°å»ºä»»åŠ¡] [åˆ·æ–°]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç­›é€‰: [å…¨éƒ¨â–¼] [è¿è¡Œä¸­] [å·²å®Œæˆ] [å¤±è´¥]  ğŸ” æœç´¢...    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ”„ è¡¨å•è‡ªåŠ¨å¡«å†™ - example.com      è¿è¡Œä¸­        â”‚  â”‚
â”‚  â”‚    æ­¥éª¤ 3/5: å¡«å†™è”ç³»ä¿¡æ¯                        â”‚  â”‚
â”‚  â”‚    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 60%                    â”‚  â”‚
â”‚  â”‚    å¼€å§‹æ—¶é—´: 14:23:15  é¢„è®¡å‰©ä½™: 45ç§’            â”‚  â”‚
â”‚  â”‚    [æš‚åœ] [å–æ¶ˆ] [æŸ¥çœ‹è¯¦æƒ…]                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ âœ… ç«å“ä»·æ ¼ç›‘æ§                 å·²å®Œæˆ            â”‚  â”‚
â”‚  â”‚    é‡‡é›† 50 ä¸ªäº§å“ä»·æ ¼                            â”‚  â”‚
â”‚  â”‚    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%                    â”‚  â”‚
â”‚  â”‚    å®Œæˆæ—¶é—´: 14:20:33  ç”¨æ—¶: 2åˆ†15ç§’             â”‚  â”‚
â”‚  â”‚    [æŸ¥çœ‹ç»“æœ] [é‡æ–°è¿è¡Œ] [å¯¼å‡ºæ•°æ®]              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ âŒ ç™»å½•å¤±è´¥ - secure-site.com   å¤±è´¥              â”‚  â”‚
â”‚  â”‚    é”™è¯¯: éªŒè¯ç è¯†åˆ«å¤±è´¥                          â”‚  â”‚
â”‚  â”‚    å¤±è´¥æ—¶é—´: 14:18:22                            â”‚  â”‚
â”‚  â”‚    [æŸ¥çœ‹æ—¥å¿—] [ä¿®æ”¹é…ç½®] [é‡è¯•]                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2.3 æŠ€æœ¯å®ç°
```typescript
// å‰ç«¯ï¼šä»»åŠ¡çŠ¶æ€ç®¡ç†
interface Task {
  id: string;
  name: string;
  status: 'pending' | 'running' | 'completed' | 'failed';
  progress: number;
  currentStep: string;
  totalSteps: number;
  startTime: Date;
  endTime?: Date;
  error?: string;
}

class TaskStore {
  private tasks: Map<string, Task> = new Map();

  updateTask(taskUpdate: TaskUpdate): void {
    const task = this.tasks.get(taskUpdate.id);
    if (task) {
      Object.assign(task, taskUpdate);
      this.notifySubscribers(task);
    }
  }

  subscribeToTask(taskId: string, callback: (task: Task) => void): void {
    // WebSocket è®¢é˜…ä»»åŠ¡æ›´æ–°
  }
}
```

```rust
// åç«¯ï¼šä»»åŠ¡çŠ¶æ€æ¨é€
use tokio::sync::broadcast;

pub struct TaskStatusBroadcaster {
    tx: broadcast::Sender<TaskUpdate>,
}

impl TaskStatusBroadcaster {
    pub fn subscribe(&self) -> broadcast::Receiver<TaskUpdate> {
        self.tx.subscribe()
    }

    pub async fn broadcast_update(&self, update: TaskUpdate) {
        let _ = self.tx.send(update);
    }
}

// WebSocket å¤„ç†å™¨
pub async fn task_updates_handler(
    ws: WebSocket,
    broadcaster: Arc<TaskStatusBroadcaster>,
) {
    let mut rx = broadcaster.subscribe();

    while let Ok(update) = rx.recv().await {
        let json = serde_json::to_string(&update).unwrap();
        ws.send(Message::Text(json)).await.ok();
    }
}
```

### 2.3 å®æ—¶æµè§ˆå™¨é¢„è§ˆ

#### 2.3.1 åŠŸèƒ½éœ€æ±‚
- å®æ—¶æˆªå›¾æµå±•ç¤º
- å…ƒç´ é«˜äº®æ˜¾ç¤º
- æ“ä½œè½¨è¿¹å›æ”¾
- è§†è§‰é”šç‚¹æ ‡æ³¨
- é¡µé¢ DOM ç»“æ„æŸ¥çœ‹å™¨
- æˆªå›¾å†å²æµè§ˆ

#### 2.3.2 ç•Œé¢è®¾è®¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®æ—¶é¢„è§ˆ                      [å…¨å±] [æˆªå›¾] [å½•åˆ¶]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŒ https://example.com/contact                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                â”‚  â”‚ æ“ä½œå†å²       â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€[é«˜äº®]â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚ âœ“ é¡µé¢åŠ è½½     â”‚ â”‚
â”‚  â”‚   â”‚  [Name Input Field]  â”‚     â”‚  â”‚ âœ“ ç‚¹å‡»ç™»å½•     â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚ âœ“ è¾“å…¥ç”¨æˆ·å   â”‚ â”‚
â”‚  â”‚                                â”‚  â”‚ â–¶ å¡«å†™è¡¨å•     â”‚ â”‚
â”‚  â”‚   â–¼ å½“å‰æ“ä½œ: è¾“å…¥æ–‡æœ¬        â”‚  â”‚   ç­‰å¾…éªŒè¯...  â”‚ â”‚
â”‚  â”‚      "John Doe"                â”‚  â”‚                â”‚ â”‚
â”‚  â”‚                                â”‚  â”‚ æ—¶é—´è½´:        â”‚ â”‚
â”‚  â”‚   [ Submit ]  [ Cancel ]      â”‚  â”‚ â”â”â”â—â”â”â”â”â”â”     â”‚ â”‚
â”‚  â”‚                                â”‚  â”‚ 0s    5s   10s â”‚ â”‚
â”‚  â”‚                                â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸ¯ å½“å‰æ­¥éª¤: å¡«å†™è”ç³»è¡¨å• (3/5)                 â”‚    â”‚
â”‚  â”‚ å®šä½ç­–ç•¥: CSS Selector (#contact-name)          â”‚    â”‚
â”‚  â”‚ ç½®ä¿¡åº¦: 95%                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  [< ä¸Šä¸€å¸§] [â¸ æš‚åœ] [â–¶ ç»§ç»­] [ä¸‹ä¸€å¸§ >]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.3.3 æŠ€æœ¯å®ç°
```typescript
// å‰ç«¯ï¼šå®æ—¶æˆªå›¾æ¸²æŸ“
class BrowserPreview {
  private canvas: HTMLCanvasElement;
  private overlays: ElementOverlay[] = [];

  updateScreenshot(base64Image: string): void {
    const img = new Image();
    img.onload = () => {
      const ctx = this.canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      this.renderOverlays();
    };
    img.src = `data:image/png;base64,${base64Image}`;
  }

  addOverlay(overlay: ElementOverlay): void {
    this.overlays.push(overlay);
    this.renderOverlays();
  }

  private renderOverlays(): void {
    const ctx = this.canvas.getContext('2d');
    for (const overlay of this.overlays) {
      // ç»˜åˆ¶é«˜äº®æ¡†
      ctx.strokeStyle = '#00ff00';
      ctx.lineWidth = 2;
      ctx.strokeRect(
        overlay.x, overlay.y,
        overlay.width, overlay.height
      );

      // ç»˜åˆ¶æ ‡ç­¾
      ctx.fillStyle = '#00ff00';
      ctx.fillText(overlay.label, overlay.x, overlay.y - 5);
    }
  }
}
```

```rust
// åç«¯ï¼šæˆªå›¾æµæ¨é€
use cdp_adapter::CdpClient;

pub struct ScreenshotStreamer {
    cdp_client: Arc<CdpClient>,
    broadcaster: Arc<Broadcaster<ScreenshotFrame>>,
}

impl ScreenshotStreamer {
    pub async fn start_streaming(&self, interval_ms: u64) {
        let mut interval = tokio::time::interval(
            Duration::from_millis(interval_ms)
        );

        loop {
            interval.tick().await;

            // è·å–æˆªå›¾
            let screenshot = self.cdp_client
                .capture_screenshot()
                .await
                .ok();

            if let Some(data) = screenshot {
                let frame = ScreenshotFrame {
                    timestamp: Utc::now(),
                    data: base64::encode(&data),
                    overlays: self.get_current_overlays().await,
                };

                self.broadcaster.send(frame).await;
            }
        }
    }

    async fn get_current_overlays(&self) -> Vec<ElementOverlay> {
        // ä» Perceiver è·å–å½“å‰å…³æ³¨çš„å…ƒç´ ä½ç½®
        vec![]
    }
}
```

### 2.4 ç›‘æ§ä»ªè¡¨ç›˜

#### 2.4.1 åŠŸèƒ½éœ€æ±‚
- ä»»åŠ¡æˆåŠŸç‡ç»Ÿè®¡
- æ€§èƒ½æŒ‡æ ‡å±•ç¤ºï¼ˆå“åº”æ—¶é—´ã€èµ„æºä½¿ç”¨ï¼‰
- é”™è¯¯ç‡è¶‹åŠ¿å›¾
- ç½‘ç»œè¯·æ±‚ç›‘æ§
- ç­–ç•¥åˆè§„æ€§æŠ¥å‘Š

#### 2.4.2 ç•Œé¢è®¾è®¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç›‘æ§ä»ªè¡¨ç›˜                    æ—¶é—´èŒƒå›´: [æœ€è¿‘24å°æ—¶â–¼]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ€»ä»»åŠ¡  â”‚  â”‚ æˆåŠŸç‡  â”‚  â”‚ å¹³å‡è€—æ—¶â”‚  â”‚ æ´»è·ƒä»»åŠ¡â”‚   â”‚
â”‚  â”‚  156    â”‚  â”‚  92.3%  â”‚  â”‚  45.2s  â”‚  â”‚   3     â”‚   â”‚
â”‚  â”‚  â†‘ 12%  â”‚  â”‚  â†“ 1.2% â”‚  â”‚  â†“ 5.3s â”‚  â”‚         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ä»»åŠ¡æˆåŠŸç‡è¶‹åŠ¿             â”‚  â”‚ é”™è¯¯ç±»å‹åˆ†å¸ƒ        â”‚ â”‚
â”‚  â”‚                           â”‚  â”‚                    â”‚ â”‚
â”‚  â”‚   100%â”¤     â•±â•²            â”‚  â”‚  â”Œâ”€â”€â”            â”‚ â”‚
â”‚  â”‚    90%â”¤    â•±  â•²â•±â•²         â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”     â”‚ â”‚
â”‚  â”‚    80%â”¤   â•±         â•²     â”‚  â”‚  â”‚  â”‚  â”‚  â”‚ â”Œâ”€â” â”‚ â”‚
â”‚  â”‚    70%â”¤  â•±           â•²    â”‚  â”‚  â”‚  â”‚  â”‚  â”‚ â”‚ â”‚ â”‚ â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â””â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”´â”€â”˜ â”‚ â”‚
â”‚  â”‚        00:00     12:00    â”‚  â”‚   ç½‘ç»œ å®šä½ éªŒè¯  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æœ€è¿‘é”™è¯¯                                          â”‚ â”‚
â”‚  â”‚ â€¢ 14:22:15  ç½‘ç»œè¶…æ—¶ - api.example.com            â”‚ â”‚
â”‚  â”‚ â€¢ 14:20:03  å…ƒç´ å®šä½å¤±è´¥ - #submit-button         â”‚ â”‚
â”‚  â”‚ â€¢ 14:18:42  éªŒè¯ç è¯†åˆ«å¤±è´¥ - captcha-image        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.4.3 æŠ€æœ¯å®ç°
```typescript
// å‰ç«¯ï¼šç›‘æ§æ•°æ®å¯è§†åŒ–
import { Line, Pie } from 'recharts';

class MetricsDashboard {
  private metricsStore: MetricsStore;

  fetchMetrics(timeRange: TimeRange): void {
    fetch(`/api/metrics?from=${timeRange.from}&to=${timeRange.to}`)
      .then(res => res.json())
      .then(data => {
        this.metricsStore.update(data);
      });
  }

  renderSuccessRateChart(): JSX.Element {
    return (
      <Line
        data={this.metricsStore.successRateData}
        xAxis={{ dataKey: 'timestamp' }}
        yAxis={{ domain: [0, 100] }}
      >
        <Line dataKey="successRate" stroke="#00ff00" />
      </Line>
    );
  }
}
```

```rust
// åç«¯ï¼šæŒ‡æ ‡èšåˆå’ŒæŸ¥è¯¢
use prometheus::{HistogramVec, CounterVec};

pub struct MetricsService {
    task_duration: HistogramVec,
    task_counter: CounterVec,
}

impl MetricsService {
    pub fn new() -> Self {
        let task_duration = HistogramVec::new(
            HistogramOpts::new("task_duration_seconds", "Task duration"),
            &["task_type", "status"]
        ).unwrap();

        let task_counter = CounterVec::new(
            Opts::new("task_total", "Total tasks"),
            &["task_type", "status"]
        ).unwrap();

        Self { task_duration, task_counter }
    }

    pub async fn get_metrics(&self, range: TimeRange) -> MetricsReport {
        // æŸ¥è¯¢ Prometheus æ•°æ®
        let success_rate = self.calculate_success_rate(range).await;
        let avg_duration = self.calculate_avg_duration(range).await;
        let error_distribution = self.get_error_distribution(range).await;

        MetricsReport {
            success_rate,
            avg_duration,
            error_distribution,
            timestamp: Utc::now(),
        }
    }
}
```

### 2.5 ä»»åŠ¡è®¡åˆ’è¯¦æƒ…

#### 2.5.1 åŠŸèƒ½éœ€æ±‚
- å¯è§†åŒ–ä»»åŠ¡æµç¨‹å›¾
- æ­¥éª¤è¯¦ç»†è¯´æ˜
- é¢„æœŸç»“æœå’ŒéªŒè¯æ¡ä»¶
- é£é™©æç¤ºå’Œç­–ç•¥æ£€æŸ¥
- è®¡åˆ’ä¿®æ”¹å’Œé‡æ–°ç”Ÿæˆ

#### 2.5.2 ç•Œé¢è®¾è®¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»»åŠ¡è®¡åˆ’: è‡ªåŠ¨ç™»å½•å¹¶å¡«å†™è¡¨å•          [ç¼–è¾‘] [æ‰§è¡Œ]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ•´ä½“è¯„ä¼°:                                               â”‚
â”‚  â€¢ é¢„è®¡è€—æ—¶: 2-3 åˆ†é’Ÿ                                    â”‚
â”‚  â€¢ æˆåŠŸç‡: 85% (åŸºäºå†å²æ•°æ®)                            â”‚
â”‚  â€¢ é£é™©ç­‰çº§: ä½ âœ“ ç­–ç•¥æ£€æŸ¥é€šè¿‡                           â”‚
â”‚                                                          â”‚
â”‚  æ‰§è¡Œæµç¨‹:                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â‘  å¯¼èˆªåˆ°ç›®æ ‡ç½‘ç«™                                  â”‚ â”‚
â”‚  â”‚     â†“                                              â”‚ â”‚
â”‚  â”‚     å·¥å…·: navigate                                 â”‚ â”‚
â”‚  â”‚     ç›®æ ‡: https://example.com                      â”‚ â”‚
â”‚  â”‚     éªŒè¯: é¡µé¢æ ‡é¢˜åŒ…å« "Example"                    â”‚ â”‚
â”‚  â”‚     [æŸ¥çœ‹è¯¦æƒ…]                                     â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  â‘¡ å®šä½å¹¶å¡«å†™ç”¨æˆ·å                                â”‚ â”‚
â”‚  â”‚     â†“                                              â”‚ â”‚
â”‚  â”‚     å·¥å…·: type_text                                â”‚ â”‚
â”‚  â”‚     å®šä½: #username (ç½®ä¿¡åº¦: 95%)                  â”‚ â”‚
â”‚  â”‚     å¤‡ç”¨: input[name="user"] (ç½®ä¿¡åº¦: 80%)         â”‚ â”‚
â”‚  â”‚     éªŒè¯: è¾“å…¥æ¡†å€¼ä¸æœŸæœ›ä¸€è‡´                        â”‚ â”‚
â”‚  â”‚     [æŸ¥çœ‹è¯¦æƒ…]                                     â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  â‘¢ å®šä½å¹¶å¡«å†™å¯†ç                                   â”‚ â”‚
â”‚  â”‚     â†“                                              â”‚ â”‚
â”‚  â”‚     å·¥å…·: type_text                                â”‚ â”‚
â”‚  â”‚     å®šä½: #password (ç½®ä¿¡åº¦: 95%)                  â”‚ â”‚
â”‚  â”‚     æ³¨æ„: æ•æ„Ÿæ•°æ® - å°†è¢«åŠ å¯†å¤„ç†                   â”‚ â”‚
â”‚  â”‚     [æŸ¥çœ‹è¯¦æƒ…]                                     â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  â‘£ ç‚¹å‡»ç™»å½•æŒ‰é’®                                    â”‚ â”‚
â”‚  â”‚     â†“                                              â”‚ â”‚
â”‚  â”‚     å·¥å…·: click                                    â”‚ â”‚
â”‚  â”‚     å®šä½: button[type="submit"] (ç½®ä¿¡åº¦: 90%)      â”‚ â”‚
â”‚  â”‚     éªŒè¯: URL å˜åŒ– æˆ– å‡ºç°æ¬¢è¿ä¿¡æ¯                  â”‚ â”‚
â”‚  â”‚     [æŸ¥çœ‹è¯¦æƒ…]                                     â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  â‘¤ å¯¼èˆªåˆ°è”ç³»è¡¨å•é¡µé¢                              â”‚ â”‚
â”‚  â”‚     â†“                                              â”‚ â”‚
â”‚  â”‚     ...                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  å¤±è´¥å¤„ç†ç­–ç•¥:                                           â”‚
â”‚  â€¢ å…ƒç´ å®šä½å¤±è´¥ â†’ å°è¯•å¤‡ç”¨é€‰æ‹©å™¨ â†’ è§†è§‰å®šä½            â”‚
â”‚  â€¢ ç½‘ç»œè¶…æ—¶ â†’ é‡è¯• 3 æ¬¡ï¼ˆé—´éš” 2sï¼‰                      â”‚
â”‚  â€¢ éªŒè¯å¤±è´¥ â†’ æˆªå›¾ä¿å­˜ â†’ é€šçŸ¥ç”¨æˆ·                       â”‚
â”‚                                                          â”‚
â”‚  [è¿”å›] [ä¿®æ”¹è®¡åˆ’] [å¼€å§‹æ‰§è¡Œ]                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€å¼€å‘é˜¶æ®µè§„åˆ’

### é˜¶æ®µ 1: åŸºç¡€æ¡†æ¶æ­å»ºï¼ˆ2 å‘¨ï¼‰

#### 3.1.1 åç«¯å¼€å‘
**ä»»åŠ¡æ¸…å•**:
- [ ] åˆ›å»º `crates/web-console` æ¨¡å—
- [ ] å®ç° REST API åŸºç¡€è·¯ç”±
  - GET /api/tasks - ä»»åŠ¡åˆ—è¡¨
  - POST /api/tasks - åˆ›å»ºä»»åŠ¡
  - GET /api/tasks/:id - ä»»åŠ¡è¯¦æƒ…
  - POST /api/tasks/:id/start - å¯åŠ¨ä»»åŠ¡
  - POST /api/tasks/:id/stop - åœæ­¢ä»»åŠ¡
- [ ] å®ç° WebSocket è¿æ¥ç®¡ç†
  - è¿æ¥è®¤è¯
  - å¿ƒè·³æ£€æµ‹
  - æ–­çº¿é‡è¿
- [ ] å®ç°äº‹ä»¶å¹¿æ’­ç³»ç»Ÿ
  - ä»»åŠ¡çŠ¶æ€æ›´æ–°
  - æˆªå›¾æ¨é€
  - æ—¥å¿—æµ

**ä»£ç ç»“æ„**:
```
crates/web-console/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ tasks.rs        # ä»»åŠ¡ç®¡ç† API
â”‚   â”‚   â”œâ”€â”€ chat.rs         # å¯¹è¯ API
â”‚   â”‚   â””â”€â”€ metrics.rs      # æŒ‡æ ‡ API
â”‚   â”œâ”€â”€ ws/
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ handler.rs      # WebSocket å¤„ç†
â”‚   â”‚   â”œâ”€â”€ broadcaster.rs  # äº‹ä»¶å¹¿æ’­
â”‚   â”‚   â””â”€â”€ message.rs      # æ¶ˆæ¯å®šä¹‰
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ task_manager.rs # ä»»åŠ¡ç®¡ç†æœåŠ¡
â”‚   â”‚   â””â”€â”€ screenshot.rs   # æˆªå›¾æœåŠ¡
â”‚   â””â”€â”€ model/
â”‚       â”œâ”€â”€ mod.rs
â”‚       â”œâ”€â”€ task.rs
â”‚       â””â”€â”€ message.rs
â””â”€â”€ Cargo.toml
```

**æ ¸å¿ƒå®ç°ç¤ºä¾‹**:
```rust
// crates/web-console/src/api/tasks.rs
use axum::{
    extract::{Path, State},
    Json, Router,
    routing::{get, post},
};

pub fn routes() -> Router<AppState> {
    Router::new()
        .route("/api/tasks", get(list_tasks).post(create_task))
        .route("/api/tasks/:id", get(get_task))
        .route("/api/tasks/:id/start", post(start_task))
        .route("/api/tasks/:id/stop", post(stop_task))
}

async fn list_tasks(
    State(state): State<AppState>,
) -> Json<Vec<TaskInfo>> {
    let tasks = state.task_manager.list_tasks().await;
    Json(tasks)
}

async fn create_task(
    State(state): State<AppState>,
    Json(req): Json<CreateTaskRequest>,
) -> Json<TaskInfo> {
    let task = state.task_manager.create_task(req).await;
    Json(task)
}
```

```rust
// crates/web-console/src/ws/handler.rs
use axum::extract::ws::{WebSocket, Message};

pub async fn websocket_handler(
    ws: WebSocket,
    State(state): State<AppState>,
) {
    let (mut sender, mut receiver) = ws.split();

    // è®¢é˜…äº‹ä»¶å¹¿æ’­
    let mut event_rx = state.broadcaster.subscribe();

    // å¤„ç†æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯æ¶ˆæ¯
    let send_task = tokio::spawn(async move {
        while let Ok(event) = event_rx.recv().await {
            let json = serde_json::to_string(&event).unwrap();
            if sender.send(Message::Text(json)).await.is_err() {
                break;
            }
        }
    });

    // å¤„ç†å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨æ¶ˆæ¯
    let recv_task = tokio::spawn(async move {
        while let Some(Ok(msg)) = receiver.next().await {
            if let Message::Text(text) = msg {
                handle_client_message(&text, &state).await;
            }
        }
    });

    tokio::select! {
        _ = send_task => {},
        _ = recv_task => {},
    }
}
```

#### 3.1.2 å‰ç«¯å¼€å‘
**ä»»åŠ¡æ¸…å•**:
- [ ] åˆå§‹åŒ– React + TypeScript é¡¹ç›®
- [ ] é…ç½® Vite æ„å»ºå·¥å…·
- [ ] æ­å»ºåŸºç¡€è·¯ç”±ç»“æ„
- [ ] å®ç° WebSocket è¿æ¥ç®¡ç†
- [ ] åˆ›å»ºåŸºç¡€ UI ç»„ä»¶åº“
  - Layout å¸ƒå±€
  - Card å¡ç‰‡
  - Button æŒ‰é’®
  - Input è¾“å…¥æ¡†
  - Table è¡¨æ ¼

**ç›®å½•ç»“æ„**:
```
web-console/
â”œâ”€â”€ public/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.tsx
â”‚   â”œâ”€â”€ App.tsx
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ client.ts       # HTTP å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ websocket.ts    # WebSocket å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ common/         # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ chat/           # å¯¹è¯ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ tasks/          # ä»»åŠ¡ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ preview/        # é¢„è§ˆç»„ä»¶
â”‚   â”‚   â””â”€â”€ dashboard/      # ä»ªè¡¨ç›˜ç»„ä»¶
â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â”œâ”€â”€ taskStore.ts
â”‚   â”‚   â”œâ”€â”€ chatStore.ts
â”‚   â”‚   â””â”€â”€ metricsStore.ts
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useWebSocket.ts
â”‚   â”‚   â””â”€â”€ useTasks.ts
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”œâ”€â”€ task.ts
â”‚   â”‚   â””â”€â”€ message.ts
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ format.ts
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ vite.config.ts
```

**æ ¸å¿ƒå®ç°ç¤ºä¾‹**:
```typescript
// src/api/websocket.ts
export class WebSocketClient {
  private ws: WebSocket | null = null;
  private listeners: Map<string, Set<(data: any) => void>> = new Map();

  connect(url: string): void {
    this.ws = new WebSocket(url);

    this.ws.onopen = () => {
      console.log('WebSocket connected');
      this.sendHeartbeat();
    };

    this.ws.onmessage = (event) => {
      const message = JSON.parse(event.data);
      this.notifyListeners(message.type, message.payload);
    };

    this.ws.onerror = (error) => {
      console.error('WebSocket error:', error);
    };

    this.ws.onclose = () => {
      console.log('WebSocket closed');
      setTimeout(() => this.connect(url), 3000); // é‡è¿
    };
  }

  on(eventType: string, callback: (data: any) => void): void {
    if (!this.listeners.has(eventType)) {
      this.listeners.set(eventType, new Set());
    }
    this.listeners.get(eventType)!.add(callback);
  }

  send(type: string, payload: any): void {
    if (this.ws?.readyState === WebSocket.OPEN) {
      this.ws.send(JSON.stringify({ type, payload }));
    }
  }

  private notifyListeners(eventType: string, data: any): void {
    const listeners = this.listeners.get(eventType);
    if (listeners) {
      listeners.forEach(callback => callback(data));
    }
  }

  private sendHeartbeat(): void {
    setInterval(() => {
      this.send('ping', {});
    }, 30000);
  }
}
```

```typescript
// src/stores/taskStore.ts
import { create } from 'zustand';

interface Task {
  id: string;
  name: string;
  status: 'pending' | 'running' | 'completed' | 'failed';
  progress: number;
  // ...
}

interface TaskStore {
  tasks: Map<string, Task>;
  addTask: (task: Task) => void;
  updateTask: (id: string, updates: Partial<Task>) => void;
  removeTask: (id: string) => void;
}

export const useTaskStore = create<TaskStore>((set) => ({
  tasks: new Map(),

  addTask: (task) => set((state) => {
    const newTasks = new Map(state.tasks);
    newTasks.set(task.id, task);
    return { tasks: newTasks };
  }),

  updateTask: (id, updates) => set((state) => {
    const newTasks = new Map(state.tasks);
    const task = newTasks.get(id);
    if (task) {
      newTasks.set(id, { ...task, ...updates });
    }
    return { tasks: newTasks };
  }),

  removeTask: (id) => set((state) => {
    const newTasks = new Map(state.tasks);
    newTasks.delete(id);
    return { tasks: newTasks };
  }),
}));
```

#### 3.1.3 é›†æˆæµ‹è¯•
- [ ] å‰åç«¯è”è°ƒæµ‹è¯•
- [ ] WebSocket ç¨³å®šæ€§æµ‹è¯•
- [ ] åŸºç¡€åŠŸèƒ½ç«¯åˆ°ç«¯æµ‹è¯•

### é˜¶æ®µ 2: å¯¹è¯äº¤äº’ï¼ˆ3 å‘¨ï¼‰

#### 3.2.1 Agent Core é›†æˆ
- [ ] è¿æ¥ agent-core æ¨¡å—
- [ ] å®ç°æ„å›¾è§£æ API
- [ ] å®ç°è®¡åˆ’ç”Ÿæˆ API
- [ ] å®ç°è®¡åˆ’æ‰§è¡Œåè°ƒ

#### 3.2.2 å¯¹è¯ UI å¼€å‘
- [ ] å¯¹è¯ç•Œé¢ç»„ä»¶
- [ ] æ¶ˆæ¯æ¸²æŸ“ï¼ˆæ–‡æœ¬ã€ä»»åŠ¡è®¡åˆ’å¡ç‰‡ï¼‰
- [ ] ä»»åŠ¡æ¨¡æ¿é€‰æ‹©å™¨
- [ ] å†å²ä¼šè¯ç®¡ç†

#### 3.2.3 ä»»åŠ¡è®¡åˆ’å¯è§†åŒ–
- [ ] è®¡åˆ’è¯¦æƒ…å¡ç‰‡
- [ ] æµç¨‹å›¾æ¸²æŸ“
- [ ] æ­¥éª¤è¯¦æƒ…å±•å¼€é¢æ¿
- [ ] é£é™©æç¤ºå’Œç­–ç•¥æ£€æŸ¥å±•ç¤º

### é˜¶æ®µ 3: å®æ—¶é¢„è§ˆï¼ˆ2 å‘¨ï¼‰

#### 3.3.1 æˆªå›¾æµå®ç°
- [ ] åç«¯æˆªå›¾å®šæ—¶æ•è·
- [ ] WebSocket æˆªå›¾æ¨é€
- [ ] å‰ç«¯ Canvas æ¸²æŸ“
- [ ] æˆªå›¾å†å²ç¼“å­˜

#### 3.3.2 å…ƒç´ é«˜äº®å’Œè½¨è¿¹
- [ ] ä» Perceiver è·å–å…ƒç´ ä½ç½®
- [ ] Overlay æ¸²æŸ“ï¼ˆé«˜äº®æ¡†ã€æ ‡ç­¾ï¼‰
- [ ] æ“ä½œè½¨è¿¹åŠ¨ç”»
- [ ] æ—¶é—´è½´æ§åˆ¶

#### 3.3.3 DOM æŸ¥çœ‹å™¨
- [ ] DOM æ ‘ç»“æ„å±•ç¤º
- [ ] å…ƒç´ æ£€æŸ¥å™¨
- [ ] CSS æ ·å¼æŸ¥çœ‹

### é˜¶æ®µ 4: ä»»åŠ¡ç®¡ç†ï¼ˆ2 å‘¨ï¼‰

#### 3.4.1 ä»»åŠ¡åˆ—è¡¨å’Œç­›é€‰
- [ ] ä»»åŠ¡åˆ—è¡¨ç»„ä»¶
- [ ] çŠ¶æ€ç­›é€‰å’Œæœç´¢
- [ ] åˆ†é¡µå’Œè™šæ‹Ÿæ»šåŠ¨

#### 3.4.2 ä»»åŠ¡æ“ä½œ
- [ ] å¯åŠ¨/æš‚åœ/å–æ¶ˆä»»åŠ¡
- [ ] ä»»åŠ¡é‡è¯•
- [ ] ä»»åŠ¡é…ç½®ä¿®æ”¹

#### 3.4.3 ä»»åŠ¡è¯¦æƒ…
- [ ] è¯¦æƒ…é¡µå¸ƒå±€
- [ ] æ‰§è¡Œæ—¥å¿—æŸ¥çœ‹å™¨
- [ ] ç»“æœæ•°æ®å±•ç¤ºå’Œå¯¼å‡º

### é˜¶æ®µ 5: ç›‘æ§ä»ªè¡¨ç›˜ï¼ˆ2 å‘¨ï¼‰

#### 3.5.1 æŒ‡æ ‡é‡‡é›†
- [ ] Prometheus æŒ‡æ ‡æš´éœ²
- [ ] æŒ‡æ ‡æŸ¥è¯¢ API
- [ ] æ•°æ®èšåˆå’Œç¼“å­˜

#### 3.5.2 å›¾è¡¨å¯è§†åŒ–
- [ ] æˆåŠŸç‡è¶‹åŠ¿å›¾
- [ ] æ€§èƒ½æŒ‡æ ‡å›¾è¡¨
- [ ] é”™è¯¯åˆ†å¸ƒå›¾
- [ ] å®æ—¶ç»Ÿè®¡å¡ç‰‡

#### 3.5.3 å‘Šè­¦ç³»ç»Ÿ
- [ ] å‘Šè­¦è§„åˆ™é…ç½®
- [ ] å‘Šè­¦é€šçŸ¥ï¼ˆWebSocketï¼‰
- [ ] å‘Šè­¦å†å²æŸ¥çœ‹

### é˜¶æ®µ 6: ä¼˜åŒ–å’Œéƒ¨ç½²ï¼ˆ2 å‘¨ï¼‰

#### 3.6.1 æ€§èƒ½ä¼˜åŒ–
- [ ] å‰ç«¯ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½
- [ ] WebSocket æ¶ˆæ¯å‹ç¼©
- [ ] æˆªå›¾æµä¼˜åŒ–ï¼ˆå¢é‡æ›´æ–°ã€ç¼–ç ä¼˜åŒ–ï¼‰
- [ ] ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

#### 3.6.2 å®‰å…¨åŠ å›º
- [ ] JWT è®¤è¯é›†æˆ
- [ ] HTTPS é…ç½®
- [ ] CSRF é˜²æŠ¤
- [ ] æ•æ„Ÿæ•°æ®åŠ å¯†

#### 3.6.3 éƒ¨ç½²æ–¹æ¡ˆ
- [ ] Docker é•œåƒæ„å»º
- [ ] Nginx åå‘ä»£ç†é…ç½®
- [ ] ç”Ÿäº§ç¯å¢ƒé…ç½®
- [ ] ç›‘æ§å’Œæ—¥å¿—æ”¶é›†

---

## å››ã€æŠ€æœ¯å®ç°ç»†èŠ‚

### 4.1 WebSocket æ¶ˆæ¯åè®®

#### 4.1.1 æ¶ˆæ¯æ ¼å¼
```typescript
interface WebSocketMessage {
  type: string;           // æ¶ˆæ¯ç±»å‹
  payload: any;           // æ¶ˆæ¯å†…å®¹
  timestamp: number;      // æ—¶é—´æˆ³
  requestId?: string;     // è¯·æ±‚ IDï¼ˆç”¨äºè¯·æ±‚-å“åº”ï¼‰
}

// å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨
type ClientMessage =
  | { type: 'ping' }
  | { type: 'chat_message', payload: { content: string } }
  | { type: 'task_start', payload: { taskId: string } }
  | { type: 'task_stop', payload: { taskId: string } }
  | { type: 'subscribe_task', payload: { taskId: string } }
  | { type: 'unsubscribe_task', payload: { taskId: string } };

// æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯
type ServerMessage =
  | { type: 'pong' }
  | { type: 'task_created', payload: Task }
  | { type: 'task_updated', payload: TaskUpdate }
  | { type: 'screenshot', payload: ScreenshotFrame }
  | { type: 'log_entry', payload: LogEntry }
  | { type: 'error', payload: { message: string } };
```

#### 4.1.2 äº‹ä»¶è®¢é˜…æ¨¡å¼
```rust
// åç«¯ï¼šäº‹ä»¶è®¢é˜…ç®¡ç†
use tokio::sync::broadcast;

pub struct EventBroadcaster {
    channels: DashMap<String, broadcast::Sender<Event>>,
}

impl EventBroadcaster {
    pub fn subscribe(&self, topic: &str) -> broadcast::Receiver<Event> {
        self.channels
            .entry(topic.to_string())
            .or_insert_with(|| broadcast::channel(1000).0)
            .value()
            .subscribe()
    }

    pub fn publish(&self, topic: &str, event: Event) {
        if let Some(tx) = self.channels.get(topic) {
            let _ = tx.send(event);
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
pub async fn handle_task_update(
    task_id: &str,
    update: TaskUpdate,
    broadcaster: &EventBroadcaster,
) {
    let topic = format!("task:{}", task_id);
    broadcaster.publish(&topic, Event::TaskUpdate(update));
}
```

### 4.2 å®æ—¶æˆªå›¾ä¼˜åŒ–

#### 4.2.1 å¢é‡æ›´æ–°ç­–ç•¥
```rust
// åªåœ¨æœ‰å˜åŒ–æ—¶æ¨é€æ–°æˆªå›¾
pub struct SmartScreenshotStreamer {
    last_hash: String,
    cdp_client: Arc<CdpClient>,
}

impl SmartScreenshotStreamer {
    pub async fn capture_if_changed(&mut self) -> Option<Vec<u8>> {
        let screenshot = self.cdp_client.capture_screenshot().await.ok()?;
        let hash = self.compute_hash(&screenshot);

        if hash != self.last_hash {
            self.last_hash = hash;
            Some(screenshot)
        } else {
            None
        }
    }

    fn compute_hash(&self, data: &[u8]) -> String {
        use sha2::{Sha256, Digest};
        let mut hasher = Sha256::new();
        hasher.update(data);
        format!("{:x}", hasher.finalize())
    }
}
```

#### 4.2.2 è‡ªé€‚åº”å¸§ç‡
```rust
// æ ¹æ®æ´»åŠ¨ç¨‹åº¦è°ƒæ•´æˆªå›¾é¢‘ç‡
pub struct AdaptiveScreenshotStreamer {
    base_interval_ms: u64,
    max_interval_ms: u64,
    current_interval_ms: u64,
}

impl AdaptiveScreenshotStreamer {
    pub async fn auto_adjust_interval(&mut self, has_activity: bool) {
        if has_activity {
            // æœ‰æ´»åŠ¨æ—¶æé«˜é¢‘ç‡
            self.current_interval_ms = self.base_interval_ms;
        } else {
            // æ— æ´»åŠ¨æ—¶é™ä½é¢‘ç‡
            self.current_interval_ms =
                (self.current_interval_ms * 2).min(self.max_interval_ms);
        }
    }
}
```

### 4.3 å‰ç«¯çŠ¶æ€åŒæ­¥

#### 4.3.1 ä¹è§‚æ›´æ–°
```typescript
// å‰ç«¯ï¼šä¹è§‚æ›´æ–°ç­–ç•¥
class TaskManager {
  async startTask(taskId: string): Promise<void> {
    // 1. ä¹è§‚æ›´æ–° UI
    taskStore.updateTask(taskId, { status: 'running' });

    try {
      // 2. å‘é€è¯·æ±‚
      await api.post(`/api/tasks/${taskId}/start`);
    } catch (error) {
      // 3. å¤±è´¥æ—¶å›æ»š
      taskStore.updateTask(taskId, { status: 'pending' });
      throw error;
    }
  }
}
```

#### 4.3.2 å†²çªè§£å†³
```typescript
// ç‰ˆæœ¬å·æœºåˆ¶
interface Task {
  id: string;
  version: number;  // æ¯æ¬¡æ›´æ–°é€’å¢
  // ...
}

// WebSocket æ›´æ–°å¤„ç†
wsClient.on('task_updated', (update: TaskUpdate) => {
  const localTask = taskStore.getTask(update.id);

  if (!localTask || update.version > localTask.version) {
    // æœåŠ¡å™¨ç‰ˆæœ¬æ›´æ–°ï¼Œåº”ç”¨æ›´æ–°
    taskStore.updateTask(update.id, update);
  } else {
    // æœ¬åœ°ç‰ˆæœ¬æ›´æ–°æˆ–ç›¸åŒï¼Œå¿½ç•¥
    console.log('Ignoring stale update');
  }
});
```

---

## äº”ã€éƒ¨ç½²æ–¹æ¡ˆ

### 5.1 å¼€å‘ç¯å¢ƒ

#### 5.1.1 æœ¬åœ°å¼€å‘é…ç½®
```bash
# åç«¯å¼€å‘
cd /path/to/SoulBrowser
cargo run --bin soulbrowser -- serve --port 8080

# å‰ç«¯å¼€å‘
cd web-console
npm run dev  # Vite å¼€å‘æœåŠ¡å™¨ï¼Œç«¯å£ 5173
```

#### 5.1.2 å¼€å‘ç¯å¢ƒä»£ç†é…ç½®
```typescript
// web-console/vite.config.ts
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
      },
      '/ws': {
        target: 'ws://localhost:8080',
        ws: true,
      },
    },
  },
});
```

### 5.2 ç”Ÿäº§ç¯å¢ƒ

#### 5.2.1 Docker éƒ¨ç½²
```dockerfile
# Dockerfile
FROM rust:1.70 as backend-builder
WORKDIR /app
COPY . .
RUN cargo build --release

FROM node:18 as frontend-builder
WORKDIR /app
COPY web-console .
RUN npm install && npm run build

FROM ubuntu:22.04
RUN apt-get update && apt-get install -y \
    chromium-browser \
    && rm -rf /var/lib/apt/lists/*

COPY --from=backend-builder /app/target/release/soulbrowser /usr/local/bin/
COPY --from=frontend-builder /app/dist /var/www/html

EXPOSE 8080
CMD ["soulbrowser", "serve", "--port", "8080", "--static-dir", "/var/www/html"]
```

#### 5.2.2 Docker Compose
```yaml
# docker-compose.yml
version: '3.8'

services:
  soulbrowser:
    build: .
    ports:
      - "8080:8080"
    environment:
      - RUST_LOG=info
      - DATABASE_URL=postgresql://user:pass@db:5432/soulbrowser
    volumes:
      - ./data:/data
      - ./config:/config
    depends_on:
      - db
      - chrome

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=soulbrowser
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data

  chrome:
    image: zenika/alpine-chrome:latest
    command:
      - --no-sandbox
      - --disable-gpu
      - --remote-debugging-address=0.0.0.0
      - --remote-debugging-port=9222
    ports:
      - "9222:9222"

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - soulbrowser

volumes:
  postgres_data:
```

#### 5.2.3 Nginx é…ç½®
```nginx
# nginx.conf
upstream soulbrowser_backend {
    server soulbrowser:8080;
}

server {
    listen 80;
    server_name soulbrowser.example.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name soulbrowser.example.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    # é™æ€æ–‡ä»¶
    location / {
        root /var/www/html;
        try_files $uri $uri/ /index.html;
    }

    # API ä»£ç†
    location /api/ {
        proxy_pass http://soulbrowser_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # WebSocket ä»£ç†
    location /ws {
        proxy_pass http://soulbrowser_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 86400;
    }
}
```

---

## å…­ã€æµ‹è¯•ç­–ç•¥

### 6.1 å•å…ƒæµ‹è¯•

```rust
// åç«¯å•å…ƒæµ‹è¯•
#[cfg(test)]
mod tests {
    use super::*;

    #[tokio::test]
    async fn test_task_creation() {
        let task_manager = TaskManager::new();
        let req = CreateTaskRequest {
            name: "Test Task".to_string(),
            // ...
        };

        let task = task_manager.create_task(req).await;
        assert_eq!(task.status, TaskStatus::Pending);
    }
}
```

```typescript
// å‰ç«¯å•å…ƒæµ‹è¯•
import { describe, it, expect } from 'vitest';
import { useTaskStore } from './taskStore';

describe('TaskStore', () => {
  it('should add task', () => {
    const store = useTaskStore.getState();
    const task = { id: '1', name: 'Test', status: 'pending' };

    store.addTask(task);

    expect(store.tasks.get('1')).toEqual(task);
  });
});
```

### 6.2 é›†æˆæµ‹è¯•

```rust
// åç«¯ API é›†æˆæµ‹è¯•
#[tokio::test]
async fn test_task_api_flow() {
    let app = create_app();
    let client = TestClient::new(app);

    // åˆ›å»ºä»»åŠ¡
    let resp = client
        .post("/api/tasks")
        .json(&json!({ "name": "Test Task" }))
        .send()
        .await;
    assert_eq!(resp.status(), 200);

    let task: Task = resp.json().await;

    // å¯åŠ¨ä»»åŠ¡
    let resp = client
        .post(&format!("/api/tasks/{}/start", task.id))
        .send()
        .await;
    assert_eq!(resp.status(), 200);
}
```

### 6.3 ç«¯åˆ°ç«¯æµ‹è¯•

```typescript
// Playwright E2E æµ‹è¯•
import { test, expect } from '@playwright/test';

test('create and run task', async ({ page }) => {
  await page.goto('http://localhost:5173');

  // è¾“å…¥ä»»åŠ¡æè¿°
  await page.fill('input[placeholder="è¯·è¾“å…¥ä»»åŠ¡æè¿°"]', 'ç™»å½• example.com');
  await page.click('button:has-text("å‘é€")');

  // ç­‰å¾…ä»»åŠ¡è®¡åˆ’ç”Ÿæˆ
  await expect(page.locator('.task-plan')).toBeVisible();

  // ç‚¹å‡»æ‰§è¡Œ
  await page.click('button:has-text("å¼€å§‹æ‰§è¡Œ")');

  // éªŒè¯ä»»åŠ¡å¼€å§‹è¿è¡Œ
  await expect(page.locator('.task-status:has-text("è¿è¡Œä¸­")')).toBeVisible();
});
```

---

## ä¸ƒã€ç›‘æ§å’Œæ—¥å¿—

### 7.1 åº”ç”¨ç›‘æ§

```rust
// Prometheus æŒ‡æ ‡æš´éœ²
use prometheus::{Encoder, TextEncoder};

pub async fn metrics_handler() -> impl IntoResponse {
    let encoder = TextEncoder::new();
    let metric_families = prometheus::gather();
    let mut buffer = vec![];
    encoder.encode(&metric_families, &mut buffer).unwrap();

    (
        StatusCode::OK,
        [(header::CONTENT_TYPE, "text/plain; charset=utf-8")],
        buffer,
    )
}

// æ³¨å†Œè‡ªå®šä¹‰æŒ‡æ ‡
lazy_static! {
    static ref WS_CONNECTIONS: IntGauge = register_int_gauge!(
        "websocket_connections_total",
        "Total number of WebSocket connections"
    ).unwrap();

    static ref TASK_DURATION: HistogramVec = register_histogram_vec!(
        "task_duration_seconds",
        "Task execution duration",
        &["task_type", "status"]
    ).unwrap();
}
```

### 7.2 æ—¥å¿—æ”¶é›†

```rust
// ç»“æ„åŒ–æ—¥å¿—
use tracing::{info, error, instrument};

#[instrument(skip(task_manager))]
pub async fn execute_task(
    task_id: String,
    task_manager: Arc<TaskManager>,
) -> Result<()> {
    info!(task_id = %task_id, "Starting task execution");

    let start = Instant::now();
    let result = task_manager.execute(&task_id).await;
    let duration = start.elapsed();

    match result {
        Ok(_) => {
            info!(
                task_id = %task_id,
                duration_ms = duration.as_millis(),
                "Task completed successfully"
            );
            TASK_DURATION
                .with_label_values(&["custom", "success"])
                .observe(duration.as_secs_f64());
        }
        Err(e) => {
            error!(
                task_id = %task_id,
                error = %e,
                "Task failed"
            );
            TASK_DURATION
                .with_label_values(&["custom", "failed"])
                .observe(duration.as_secs_f64());
        }
    }

    result
}
```

---

## å…«ã€åç»­å¢å¼ºè®¡åˆ’

### 8.1 å¤šç”¨æˆ·æ”¯æŒ
- ç”¨æˆ·è®¤è¯å’Œæˆæƒ
- å·¥ä½œç©ºé—´éš”ç¦»
- å›¢é˜Ÿåä½œåŠŸèƒ½

### 8.2 ä»»åŠ¡è°ƒåº¦
- å®šæ—¶ä»»åŠ¡
- å‘¨æœŸæ€§ä»»åŠ¡
- ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†

### 8.3 ç»“æœæ•°æ®å¤„ç†
- æ•°æ®æ¸…æ´—å’Œè½¬æ¢
- æ•°æ®å¯¼å‡ºï¼ˆCSVã€JSONã€Excelï¼‰
- æ•°æ®å¯è§†åŒ–

### 8.4 ç§»åŠ¨ç«¯é€‚é…
- å“åº”å¼è®¾è®¡ä¼˜åŒ–
- ç§»åŠ¨ç«¯ä¸“å±ç•Œé¢
- PWA æ”¯æŒ

### 8.5 æ’ä»¶å¸‚åœº
- æ’ä»¶å¼€å‘ SDK
- æ’ä»¶å®¡æ ¸æµç¨‹
- æ’ä»¶å•†åº— UI

---

## ä¹ã€èµ„æºä¼°ç®—

### 9.1 äººåŠ›èµ„æº
- **åç«¯å·¥ç¨‹å¸ˆ**: 2 äºº Ã— 3 ä¸ªæœˆ
- **å‰ç«¯å·¥ç¨‹å¸ˆ**: 2 äºº Ã— 3 ä¸ªæœˆ
- **æµ‹è¯•å·¥ç¨‹å¸ˆ**: 1 äºº Ã— 2 ä¸ªæœˆ
- **UI/UX è®¾è®¡å¸ˆ**: 1 äºº Ã— 1 ä¸ªæœˆ

### 9.2 æŠ€æœ¯æ ˆå­¦ä¹ æ›²çº¿
- React/Vue: 1-2 å‘¨
- Rust + Axum: 2-3 å‘¨
- WebSocket å®æ—¶é€šä¿¡: 1 å‘¨
- ECharts æ•°æ®å¯è§†åŒ–: 1 å‘¨

### 9.3 é£é™©è¯„ä¼°
| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| WebSocket ç¨³å®šæ€§é—®é¢˜ | ä¸­ | é«˜ | å®Œå–„é‡è¿æœºåˆ¶ã€æ¶ˆæ¯é˜Ÿåˆ— |
| å®æ—¶æˆªå›¾æ€§èƒ½ç“¶é¢ˆ | é«˜ | ä¸­ | å¢é‡æ›´æ–°ã€è‡ªé€‚åº”å¸§ç‡ |
| è·¨æµè§ˆå™¨å…¼å®¹æ€§ | ä½ | ä¸­ | æµè§ˆå™¨æµ‹è¯•çŸ©é˜µ |
| Agent å“åº”å»¶è¿Ÿ | ä¸­ | é«˜ | å¼‚æ­¥å¤„ç†ã€æµå¼å“åº” |

---

## åã€æˆåŠŸæ ‡å‡†

### 10.1 åŠŸèƒ½å®Œæ•´æ€§
- âœ… å¯¹è¯å¼ä»»åŠ¡åˆ›å»º
- âœ… å®æ—¶ä»»åŠ¡ç›‘æ§
- âœ… æµè§ˆå™¨å¯è§†åŒ–é¢„è§ˆ
- âœ… ä»»åŠ¡å†å²å’Œå›æ”¾
- âœ… ç›‘æ§ä»ªè¡¨ç›˜

### 10.2 æ€§èƒ½æŒ‡æ ‡
- WebSocket å»¶è¿Ÿ < 500ms
- é¡µé¢åŠ è½½æ—¶é—´ < 2s
- æˆªå›¾æ¨é€å¸§ç‡ â‰¥ 2 FPS
- æ”¯æŒ 100+ å¹¶å‘è¿æ¥

### 10.3 ç”¨æˆ·ä½“éªŒ
- ç•Œé¢å“åº”æµç•…ï¼Œæ— æ˜æ˜¾å¡é¡¿
- æ“ä½œæ­¥éª¤ç›´è§‚æ˜“æ‡‚
- é”™è¯¯æç¤ºæ¸…æ™°æœ‰ç”¨
- æ”¯æŒé”®ç›˜å¿«æ·é”®

---

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**:
1. ç¡®è®¤æŠ€æœ¯æ ˆé€‰æ‹©ï¼ˆReact vs Vueï¼‰
2. åˆ›å»º `crates/web-console` æ¨¡å—
3. åˆå§‹åŒ–å‰ç«¯é¡¹ç›®
4. å®ç°åŸºç¡€ WebSocket é€šä¿¡
5. å¼€å‘ç¬¬ä¸€ä¸ªåŠŸèƒ½æ¨¡å—ï¼ˆä»»åŠ¡åˆ—è¡¨ï¼‰

è¿™ä¸ªè®¡åˆ’æä¾›äº†å®Œæ•´çš„å¯è§†åŒ–ç•Œé¢å¼€å‘è·¯å¾„ï¼Œä½ å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ä¼˜å…ˆçº§å’Œæ—¶é—´å®‰æ’ã€‚
