<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SoulBrowser Visual Console</title>
  <meta name="artifact-threshold" content="5242880" />
  <style>
    :root {
      --sidebar-bg: #0f172a;
      --sidebar-text: #f8fafc;
      --sidebar-muted: #cbd5f5;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.12);
      --accent-strong: rgba(37, 99, 235, 0.18);
      --success: #15803d;
      --error: #dc2626;
      --warning: #b45309;
      --surface: #ffffff;
      --surface-muted: #f1f5f9;
      --border: #e2e8f0;
      --text-dark: #0f172a;
      --text-muted: #475569;
      --code-bg: #0b1120;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(180deg, #f8fafc 0%, #eef2ff 100%);
      color: var(--text-dark);
      display: flex;
      min-height: 100vh;
      overflow: hidden;
    }

    aside.sidebar {
      width: 340px;
      background: radial-gradient(circle at top, rgba(37, 99, 235, 0.35), transparent 70%),
                  radial-gradient(circle at bottom, rgba(67, 56, 202, 0.45), transparent 65%),
                  var(--sidebar-bg);
      color: var(--sidebar-text);
      padding: 32px 28px;
      display: flex;
      flex-direction: column;
      gap: 32px;
      position: relative;
      overflow-y: auto;
      border-right: 1px solid rgba(255, 255, 255, 0.08);
    }

    aside.sidebar h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 0.4px;
    }

    aside.sidebar p {
      color: var(--sidebar-muted);
      margin: 0;
      line-height: 1.5;
      font-size: 14px;
    }

    .notice {
      padding: 12px 14px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.55);
      color: var(--sidebar-text);
      font-size: 13px;
      border: 1px solid rgba(148, 163, 184, 0.28);
    }

    .notice strong {
      display: block;
      margin-bottom: 6px;
      color: #e0e7ff;
      font-weight: 600;
    }

    .form-section {
      background: rgba(15, 23, 42, 0.55);
      border-radius: 14px;
      padding: 20px;
      border: 1px solid rgba(148, 163, 184, 0.24);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
    }

    .form-section h2 {
      margin: 0 0 14px;
      font-size: 16px;
      font-weight: 600;
    }

    label.field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 14px;
      font-size: 13px;
      color: var(--sidebar-text);
    }

    label.field span {
      font-weight: 500;
    }

    input[type="text"],
    input[type="number"],
    select {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: var(--sidebar-text);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: rgba(96, 165, 250, 0.8);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.25);
    }

    .control-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      cursor: pointer;
    }

    .checkbox-group input {
      accent-color: var(--accent);
    }

    button[type="submit"] {
      background: linear-gradient(135deg, #2563eb, #4338ca);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 12px 18px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      width: 100%;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.35);
    }

    button[type="submit"]:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(37, 99, 235, 0.42);
    }

    button[type="submit"]:disabled {
      cursor: wait;
      opacity: 0.6;
      transform: none;
      box-shadow: none;
    }

    main {
      flex: 1;
      padding: 32px 36px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .status {
      padding: 18px 22px;
      border-radius: 14px;
      background: var(--surface);
      border: 1px solid rgba(15, 23, 42, 0.05);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      font-size: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .status span.label {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 8px;
      background: rgba(148, 163, 184, 0.2);
      color: var(--text-muted);
    }

    .status.status-success {
      border-color: rgba(21, 128, 61, 0.25);
      background: rgba(236, 253, 245, 0.9);
      color: var(--success);
    }

    .status.status-error {
      border-color: rgba(220, 38, 38, 0.25);
      background: rgba(254, 226, 226, 0.9);
      color: var(--error);
    }

    .status.status-warning {
      border-color: rgba(180, 83, 9, 0.25);
      background: rgba(255, 247, 237, 0.9);
      color: var(--warning);
    }

    .status.status-muted {
      color: var(--text-muted);
    }

    .card {
      background: var(--surface);
      border-radius: 18px;
      padding: 24px 26px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: 0 24px 50px rgba(15, 23, 42, 0.08);
    }

    .card header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 18px;
    }

    .card header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .card header span.meta {
      font-size: 13px;
      color: var(--text-muted);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .summary-card {
      border-radius: 14px;
      padding: 16px;
      background: var(--surface-muted);
      border: 1px solid rgba(148, 163, 184, 0.18);
    }

    .summary-card h3 {
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .summary-card dl {
      margin: 0;
    }

    .summary-card dt {
      font-size: 13px;
      color: var(--text-muted);
    }

    .summary-card dd {
      margin: 0 0 8px;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-dark);
    }

    .insights {
      margin-top: 18px;
      padding: 14px;
      border-radius: 12px;
      background: var(--accent-soft);
      border: 1px solid rgba(37, 99, 235, 0.2);
    }

    .insights h3 {
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 600;
      color: #1d4ed8;
    }

    .insights ul {
      margin: 0;
      padding-left: 18px;
      color: #1d4ed8;
    }

    .insights li {
      margin-bottom: 6px;
    }

    details.json-dump {
      margin-top: 18px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.92);
      color: #f8fafc;
      border: 1px solid rgba(37, 99, 235, 0.32);
      overflow: hidden;
    }

    details.json-dump summary {
      cursor: pointer;
      padding: 14px 18px;
      background: rgba(37, 99, 235, 0.25);
      font-weight: 600;
    }

    details.json-dump pre {
      margin: 0;
      padding: 18px;
      white-space: pre-wrap;
      font-family: "JetBrains Mono", "Fira Code", "SFMono-Regular", Consolas, monospace;
      font-size: 13px;
      background: transparent;
    }

    .log-columns {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 18px;
    }

    pre.log {
      margin: 0;
      padding: 16px;
      background: var(--code-bg);
      color: #dbeafe;
      border-radius: 12px;
      border: 1px solid rgba(37, 99, 235, 0.28);
      max-height: 280px;
      overflow: auto;
      font-size: 13px;
    }

    .screenshot {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: flex-start;
    }

    .screenshot img {
      max-width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.18);
    }

    .timeline-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .timeline-item {
      padding: 12px 14px;
      border-radius: 12px;
      background: var(--surface-muted);
      border: 1px solid rgba(148, 163, 184, 0.2);
      cursor: pointer;
      transition: transform 0.12s ease, background 0.12s ease;
    }

    .timeline-item:hover {
      transform: translateX(4px);
      background: rgba(37, 99, 235, 0.08);
    }

    .timeline-item strong {
      display: block;
      font-size: 14px;
    }

    .timeline-item span {
      color: var(--text-muted);
      font-size: 12px;
    }

    .artifact-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
    }

    .artifact-card {
      position: relative;
      padding: 16px;
      border-radius: 14px;
      background: var(--surface-muted);
      border: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .artifact-card.active {
      border-color: rgba(37, 99, 235, 0.65);
      box-shadow: 0 10px 28px rgba(37, 99, 235, 0.25);
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      background: rgba(37, 99, 235, 0.12);
      color: #1d4ed8;
    }

    .badge.warn {
      background: rgba(220, 38, 38, 0.12);
      color: #b91c1c;
    }

    .artifact-card img {
      max-width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .artifact-card a {
      font-size: 13px;
      text-decoration: none;
      color: var(--accent);
      font-weight: 600;
    }

    .bundle-summary {
      margin-bottom: 16px;
      font-size: 14px;
      color: var(--text-muted);
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 1080px) {
      body {
        flex-direction: column;
      }

      aside.sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid rgba(148, 163, 184, 0.24);
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div>
      <h1>SoulBrowser Console</h1>
      <p>Run perception flows in real time, inspect artifacts, and review automation telemetry.</p>
    </div>

    <div class="notice hidden" id="interactive-disabled">
      <strong>Interactive mode unavailable</strong>
      Launch the console via <code>soulbrowser --metrics-port 0 serve</code> to enable live perception runs.
    </div>

    <div class="form-section">
      <h2>Perception Runner</h2>
      <form id="perception-form">
        <label class="field">
          <span>Target URL</span>
          <input type="text" id="input-url" name="url" placeholder="https://example.com" required />
        </label>

        <label class="field">
          <span>Mode</span>
          <select id="mode-select" name="mode">
            <option value="all" selected>All (structural + visual + semantic)</option>
            <option value="structural">Structural only</option>
            <option value="visual">Visual only</option>
            <option value="semantic">Semantic only</option>
            <option value="custom">Custom selection</option>
          </select>
        </label>

        <div class="checkbox-group" id="custom-options">
          <label><input type="checkbox" id="opt-structural" /> Structural</label>
          <label><input type="checkbox" id="opt-visual" /> Visual</label>
          <label><input type="checkbox" id="opt-semantic" /> Semantic</label>
        </div>

        <div class="checkbox-group">
          <label><input type="checkbox" id="opt-insights" checked /> Generate insights</label>
          <label><input type="checkbox" id="opt-screenshot" checked /> Capture screenshot</label>
        </div>

        <div class="control-row">
          <label class="field" style="flex: 1 1 160px;">
            <span>Timeout (seconds)</span>
            <input type="number" id="input-timeout" min="5" max="180" step="5" placeholder="45" />
          </label>
        </div>

        <button type="submit" id="run-button">Run perception</button>
      </form>
    </div>

    <p>Tip: connect to a running Chrome instance by setting <code>SOULBROWSER_WS_URL</code> before launching the console.</p>
  </aside>

  <main>
    <section id="status-panel" class="status status-muted">
      <span class="label">Idle</span>
      <div>Ready whenever you are.</div>
    </section>

    <section class="card" id="perception-card">
      <header>
        <h2>Latest Perception</h2>
        <span class="meta" id="perception-meta">Awaiting first run</span>
      </header>
      <div class="summary-grid" id="summary-grid"></div>
      <div class="insights hidden" id="insights-block">
        <h3>Cross-modal insights</h3>
        <ul id="insights-list"></ul>
      </div>
      <details class="json-dump hidden" id="perception-json">
        <summary>Raw JSON payload</summary>
        <pre id="perception-json-pre"></pre>
      </details>
    </section>

    <section class="card hidden" id="screenshot-card">
      <header>
        <h2>Screenshot</h2>
        <span class="meta">Captured from the visual perceiver</span>
      </header>
      <div class="screenshot">
        <img id="screenshot-img" alt="Perception screenshot" />
        <a id="screenshot-download" href="#" download="soulbrowser_screenshot.png">Download PNG</a>
      </div>
    </section>

    <section class="card" id="logs-card">
      <header>
        <h2>Runtime logs</h2>
        <span class="meta">Captured from the perception subprocess</span>
      </header>
      <div class="log-columns">
        <div>
          <h3>stdout</h3>
          <pre class="log" id="stdout-log">(no output yet)</pre>
        </div>
        <div>
          <h3>stderr</h3>
          <pre class="log" id="stderr-log">(no output yet)</pre>
        </div>
      </div>
    </section>

    <section class="card hidden" id="timeline-card">
      <header>
        <h2>Recorded timeline</h2>
        <span class="meta">State center events from saved run bundle</span>
      </header>
      <div class="bundle-summary" id="bundle-summary"></div>
      <div class="timeline-list" id="timeline-list"></div>
      <p id="timeline-empty" class="hidden">No timeline events available.</p>
    </section>

    <section class="card hidden" id="artifacts-card">
      <header>
        <h2>Artifacts</h2>
        <span class="meta">Artifacts captured during execution</span>
      </header>
      <div class="bundle-summary" id="artifact-summary"></div>
      <div class="artifact-grid" id="artifact-grid"></div>
    </section>
  </main>

  <script>
    (function() {
      const state = {
        serveMode: false,
        lastActionId: null,
      };

      document.addEventListener('DOMContentLoaded', init);

      async function init() {
        setupForm();
        await detectServeMode();
        await tryLoadRunBundle();
      }

      function setupForm() {
        const form = document.getElementById('perception-form');
        if (!form) {
          return;
        }
        const modeSelect = document.getElementById('mode-select');
        const structural = document.getElementById('opt-structural');
        const visual = document.getElementById('opt-visual');
        const semantic = document.getElementById('opt-semantic');
        const options = document.getElementById('custom-options');
        const insights = document.getElementById('opt-insights');
        const screenshot = document.getElementById('opt-screenshot');
        const timeout = document.getElementById('input-timeout');
        const urlInput = document.getElementById('input-url');
        const submit = document.getElementById('run-button');

        urlInput.value = urlInput.value || 'https://example.com';

        function syncCustomOptions() {
          const mode = modeSelect.value;
          const custom = mode === 'custom';
          options.classList.toggle('hidden', !custom);
          structural.disabled = !custom;
          visual.disabled = !custom;
          semantic.disabled = !custom;
          if (!custom) {
            structural.checked = false;
            visual.checked = false;
            semantic.checked = false;
          }
        }

        modeSelect.addEventListener('change', syncCustomOptions);
        syncCustomOptions();

        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!state.serveMode) {
            setStatus('error', 'Interactive API is not available in console playback mode. Launch with `soulbrowser serve` to run perceptions.');
            return;
          }

          const payload = {
            url: urlInput.value.trim(),
            mode: modeSelect.value === 'custom' ? null : modeSelect.value,
            structural: structural.checked || undefined,
            visual: visual.checked || undefined,
            semantic: semantic.checked || undefined,
            insights: insights.checked,
            screenshot: screenshot.checked,
          };

          const timeoutValue = timeout.value.trim();
          if (timeoutValue) {
            payload.timeout = Number(timeoutValue);
          }

          await runPerception(payload, submit);
        });
      }

      async function detectServeMode() {
        try {
          const res = await fetch('/health', { cache: 'no-store' });
          state.serveMode = res.ok;
        } catch (err) {
          state.serveMode = false;
        }

        const notice = document.getElementById('interactive-disabled');
        const form = document.getElementById('perception-form');
        const submit = document.getElementById('run-button');

        if (!state.serveMode) {
          notice.classList.remove('hidden');
          if (submit) {
            submit.disabled = true;
          }
        } else {
          notice.classList.add('hidden');
          if (submit) {
            submit.disabled = false;
          }
        }
      }

      async function tryLoadRunBundle() {
        try {
          const res = await fetch('/data', { cache: 'no-store' });
          if (!res.ok) {
            return;
          }
          const payload = await res.json();
          renderRunBundle(payload);
        } catch (err) {
          console.warn('No run bundle available:', err);
        }
      }

      function renderRunBundle(payload) {
        const events = payload.state_events || [];
        const artifacts = payload.artifacts?.items || payload.artifacts || [];
        const summary = payload.artifacts?.summary || null;

        renderTimeline(events);
        renderArtifactSummary(summary);
        renderArtifacts(artifacts);
      }

      function renderTimeline(events) {
        const card = document.getElementById('timeline-card');
        const list = document.getElementById('timeline-list');
        const empty = document.getElementById('timeline-empty');

        if (!list || !card) {
          return;
        }

        list.innerHTML = '';

        if (!events || events.length === 0) {
          card.classList.add('hidden');
          empty.classList.remove('hidden');
          return;
        }

        card.classList.remove('hidden');
        empty.classList.add('hidden');

        events.forEach(evt => {
          const div = document.createElement('div');
          div.className = 'timeline-item';
          const type = evt.type || evt.event_type || 'event';
          const detail = evt.tool || evt.action || evt.phase || evt.kind || '';
          div.innerHTML = `<strong>${escapeHtml(type)}</strong><span>${escapeHtml(detail)}</span>`;
          div.addEventListener('click', () => highlightArtifacts(evt.action_id));
          list.appendChild(div);
        });
      }

      function renderArtifactSummary(summary) {
        const target = document.getElementById('artifact-summary');
        if (!target) {
          return;
        }

        if (!summary || !summary.count) {
          target.textContent = 'No artifacts captured during this run.';
          return;
        }

        const parts = [];
        parts.push(`Artifacts: ${summary.count}`);
        if (summary.total_bytes) {
          parts.push(`Total size ${formatBytes(summary.total_bytes)}`);
        }
        if (summary.average_bytes) {
          parts.push(`Average size ${formatBytes(summary.average_bytes)}`);
        }

        target.textContent = parts.join(' • ');
      }

      function renderArtifacts(items) {
        const card = document.getElementById('artifacts-card');
        const grid = document.getElementById('artifact-grid');
        if (!grid || !card) {
          return;
        }

        grid.innerHTML = '';

        if (!items || items.length === 0) {
          card.classList.add('hidden');
          return;
        }

        card.classList.remove('hidden');

        const threshold = summaryLargeThreshold();
        items.forEach(item => {
          const cardEl = document.createElement('div');
          cardEl.className = 'artifact-card';
          cardEl.dataset.actionId = item.action_id || '';

          const badges = document.createElement('div');
          const dispatchBadge = document.createElement('span');
          dispatchBadge.className = 'badge';
          dispatchBadge.textContent = item.dispatch_label || 'action';
          badges.appendChild(dispatchBadge);

          if (item.byte_len && item.byte_len >= threshold) {
            const warn = document.createElement('span');
            warn.className = 'badge warn';
            warn.textContent = 'Large';
            badges.appendChild(warn);
          }

          cardEl.appendChild(badges);

          if (item.content_type && item.content_type.startsWith('image/') && item.data_base64) {
            const img = document.createElement('img');
            img.src = `data:${item.content_type};base64,${item.data_base64}`;
            img.alt = item.label || 'Artifact screenshot';
            cardEl.appendChild(img);
          }

          const title = document.createElement('div');
          const label = item.label || 'artifact';
          const size = formatBytes(item.byte_len || 0);
          title.innerHTML = `<strong>${escapeHtml(label)}</strong><br/><small>${size}</small>`;
          cardEl.appendChild(title);

          if (item.filename && item.data_base64) {
            const link = document.createElement('a');
            link.href = `data:${item.content_type || 'application/octet-stream'};base64,${item.data_base64}`;
            link.download = item.filename;
            link.textContent = 'Download';
            cardEl.appendChild(link);
          }

          grid.appendChild(cardEl);
        });
      }

      function highlightArtifacts(actionId) {
        state.lastActionId = actionId || null;
        document.querySelectorAll('.artifact-card').forEach(el => {
          if (!state.lastActionId) {
            el.classList.remove('active');
          } else if (el.dataset.actionId === state.lastActionId) {
            el.classList.add('active');
          } else {
            el.classList.remove('active');
          }
        });
      }

      async function runPerception(payload, submitButton) {
        try {
          setStatus('info', 'Running perception...');
          if (submitButton) {
            submitButton.disabled = true;
          }

          const body = Object.assign({}, payload);
          if (payload.mode === null) {
            delete body.mode;
          }
          if (payload.structural === undefined) {
            delete body.structural;
          }
          if (payload.visual === undefined) {
            delete body.visual;
          }
          if (payload.semantic === undefined) {
            delete body.semantic;
          }

          const response = await fetch('/api/perceive', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });

          const data = await response.json().catch(() => ({ success: false, error: 'Failed to parse response.' }));

          if (!response.ok) {
            const message = data.error || `Request failed with status ${response.status}`;
            setStatus('error', message);
          } else if (!data.success) {
            setStatus('warning', data.error || 'Perception run reported an error.');
          } else {
            setStatus('success', 'Perception completed successfully.');
          }

          renderExecution(data);
        } catch (err) {
          console.error(err);
          setStatus('error', `Failed to reach console API: ${err.message || err}`);
        } finally {
          if (submitButton) {
            submitButton.disabled = false;
          }
        }
      }

      function renderExecution(payload) {
        renderPerception(payload.perception);
        renderLogs(payload.stdout || '', payload.stderr || '');
        renderScreenshot(payload.screenshot_base64);
      }

      function renderPerception(perception) {
        const meta = document.getElementById('perception-meta');
        const grid = document.getElementById('summary-grid');
        const jsonBlock = document.getElementById('perception-json');
        const jsonPre = document.getElementById('perception-json-pre');
        const insightsBlock = document.getElementById('insights-block');
        const insightsList = document.getElementById('insights-list');

        grid.innerHTML = '';
        insightsList.innerHTML = '';

        if (!perception) {
          meta.textContent = 'No perception data yet';
          jsonBlock.classList.add('hidden');
          insightsBlock.classList.add('hidden');
          return;
        }

        const timestamp = new Date().toLocaleTimeString();
        meta.textContent = `Confidence ${(perception.confidence * 100).toFixed(1)}% • ${timestamp}`;

        const structural = perception.structural || {};
        const structuralCard = document.createElement('div');
        structuralCard.className = 'summary-card';
        structuralCard.innerHTML = `
          <h3>Structural</h3>
          <dl>
            <dt>DOM nodes</dt>
            <dd>${structural.dom_node_count ?? '—'}</dd>
            <dt>Interactive elements</dt>
            <dd>${structural.interactive_element_count ?? '—'}</dd>
            <dt>Forms</dt>
            <dd>${formatBool(structural.has_forms)}</dd>
            <dt>Navigation</dt>
            <dd>${formatBool(structural.has_navigation)}</dd>
          </dl>
        `;
        grid.appendChild(structuralCard);

        if (perception.visual) {
          const visual = perception.visual;
          const visualCard = document.createElement('div');
          visualCard.className = 'summary-card';
          visualCard.innerHTML = `
            <h3>Visual</h3>
            <dl>
              <dt>Avg contrast</dt>
              <dd>${visual.avg_contrast.toFixed(2)}</dd>
              <dt>Viewport usage</dt>
              <dd>${(visual.viewport_utilization * 100).toFixed(1)}%</dd>
              <dt>Complexity</dt>
              <dd>${visual.complexity.toFixed(2)}</dd>
              <dt>Colors</dt>
              <dd>${visual.dominant_colors.length}</dd>
            </dl>
          `;
          grid.appendChild(visualCard);
        }

        if (perception.semantic) {
          const semantic = perception.semantic;
          const semanticCard = document.createElement('div');
          semanticCard.className = 'summary-card';
          semanticCard.innerHTML = `
            <h3>Semantic</h3>
            <dl>
              <dt>Content type</dt>
              <dd>${escapeHtml(semantic.content_type || 'unknown')}</dd>
              <dt>Intent</dt>
              <dd>${escapeHtml(semantic.intent || 'unknown')}</dd>
              <dt>Language</dt>
              <dd>${escapeHtml(semantic.language)} (${(semantic.language_confidence * 100).toFixed(1)}%)</dd>
              <dt>Readability</dt>
              <dd>${semantic.readability != null ? semantic.readability.toFixed(1) : 'n/a'}</dd>
            </dl>
          `;
          grid.appendChild(semanticCard);
        }

        if (Array.isArray(perception.insights) && perception.insights.length > 0) {
          insightsBlock.classList.remove('hidden');
          perception.insights.forEach(insight => {
            const li = document.createElement('li');
            const type = insight.insight_type || 'Insight';
            const confidence = insight.confidence != null ? `${(insight.confidence * 100).toFixed(0)}%` : 'n/a';
            li.textContent = `[${type}] ${insight.description || ''} (confidence ${confidence})`;
            insightsList.appendChild(li);
          });
        } else {
          insightsBlock.classList.add('hidden');
        }

        jsonBlock.classList.remove('hidden');
        jsonPre.textContent = JSON.stringify(perception, null, 2);
      }

      function renderLogs(stdout, stderr) {
        document.getElementById('stdout-log').textContent = stdout || '(no output)';
        document.getElementById('stderr-log').textContent = stderr || '(no output)';
      }

      function renderScreenshot(base64) {
        const card = document.getElementById('screenshot-card');
        const img = document.getElementById('screenshot-img');
        const link = document.getElementById('screenshot-download');

        if (!base64) {
          card.classList.add('hidden');
          img.removeAttribute('src');
          return;
        }

        const dataUrl = `data:image/png;base64,${base64}`;
        img.src = dataUrl;
        link.href = dataUrl;
        card.classList.remove('hidden');
      }

      function setStatus(kind, message) {
        const panel = document.getElementById('status-panel');
        const label = panel.querySelector('.label');
        panel.className = 'status';
        label.textContent = kind.toUpperCase();
        switch (kind) {
          case 'success':
            panel.classList.add('status-success');
            break;
          case 'error':
            panel.classList.add('status-error');
            break;
          case 'warning':
            panel.classList.add('status-warning');
            break;
          case 'info':
            panel.classList.add('status-muted');
            break;
          default:
            panel.classList.add('status-muted');
            break;
        }
        panel.lastElementChild.textContent = message;
      }

      function formatBytes(bytes) {
        if (!bytes) {
          return '0 B';
        }
        const units = ['B', 'KB', 'MB', 'GB'];
        let idx = 0;
        let value = bytes;
        while (value >= 1024 && idx < units.length - 1) {
          value /= 1024;
          idx += 1;
        }
        return `${value.toFixed(1)} ${units[idx]}`;
      }

      function summaryLargeThreshold() {
        const meta = document.querySelector('meta[name="artifact-threshold"]');
        return meta ? Number(meta.content) : 0;
      }

      function formatBool(value) {
        if (value === true) {
          return 'Yes';
        }
        if (value === false) {
          return 'No';
        }
        return '—';
      }

      function escapeHtml(input) {
        if (typeof input !== 'string') {
          return input;
        }
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
        };
        return input.replace(/[&<>"']/g, (ch) => map[ch]);
      }
    })();
  </script>
</body>
</html>
